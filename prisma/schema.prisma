// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PG_DATABASE_URL")
}

/// *
/// * User Model
/// * @model
/// * Central user entity for authentication and system access
/// * Relationships:
/// * - One-to-many with Sessions, Accounts, Queues
/// * - One-to-one with Profile
/// * - Many-to-many with Permissions
model User {
  id            String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String       @unique
  name          String
  emailVerified Boolean
  image         String?
  username      String?      @unique
  role          UserRole     @default(ADMIN)
  permissions   Permission[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  lastLoginAt   DateTime?
  language      String?      @default("en")
  active        Boolean      @default(true)

  accounts      Account[]
  attachments   Attachment[]
  auditLogs     AuditLog[]
  notifications Notification[]
  profile       Profile?
  queues        Queue[]
  sessions      Session[]
  workflows     Workflow[]
  feedback      Feedback[]
  preparedForms CivilRegistryForm[] @relation("PreparedBy")
  verifiedForms CivilRegistryForm[] @relation("VerifiedBy")

  @@map("user")
}

/// *
/// * CivilRegistryForm Model
/// * @model
/// * Stores civil registry form data for individuals who do not need authentication
/// * Relationships:
/// * - Many-to-one with User (preparedBy, verifiedBy)
model CivilRegistryForm {
  id                          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  formType                    FormType
  pageNumber                  String
  bookNumber                  String
  registryNumber              String
  dateOfRegistration          DateTime
  husbandName                 String?
  wifeName                    String?
  husbandDateOfBirth          DateTime?
  wifeDateOfBirth             DateTime?
  husbandAge                  Int?
  wifeAge                     Int?
  husbandCitizenship          String?
  wifeCitizenship             String?
  husbandCivilStatus          String?
  wifeCivilStatus             String?
  husbandMother               String?
  wifeMother                  String?
  husbandFather               String?
  wifeFather                  String?
  husbandRegistryNumber       String?
  wifeRegistryNumber          String?
  husbandDateOfRegistryNumber DateTime?
  wifeDateOfRegistryNumber    DateTime?
  dateOfMarriage              DateTime?
  placeOfMarriage             String?
  nameOfChild                 String?
  sex                         String?
  dateOfBirth                 DateTime?
  placeOfBirth                String?
  nameOfMother                String?
  citizenshipOfMother         String?
  nameOfFather                String?
  citizenshipOfFather         String?
  dateOfMarriageParents       DateTime?
  placeOfMarriageParents      String?
  nameOfDeceased              String?
  age                         Int?
  civilStatus                 String?
  citizenship                 String?
  dateOfDeath                 DateTime?
  placeOfDeath                String?
  causeOfDeath                String?
  preparedById                String?   @db.Uuid
  verifiedById                String?   @db.Uuid
  preparedBy                  User?     @relation("PreparedBy", fields: [preparedById], references: [id])
  verifiedBy                  User?     @relation("VerifiedBy", fields: [verifiedById], references: [id])
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt

  @@map("civil_registry_form")
}

/// *
/// * CertifiedCopy Model
/// * @model 
/// * Represents an application for a certified true copy of an attachment
/// * Features:
/// * - Applicant information
/// * - Application metadata
/// * - Relationship to the original attachment
model CertifiedCopy {
  id                  String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lcrNo               String?
  bookNo              String?
  pageNo              String?
  searchedBy          String?
  contactNo           String?
  date                DateTime?
  attachment          Attachment @relation(fields: [attachmentId], references: [id])
  attachmentId        String     @db.Uuid
  requesterName       String
  relationshipToOwner String
  address             String
  purpose             String
  remarks             String?
  signature           String?
  amountPaid          Float?
  orNumber            String?
  datePaid            DateTime?
  registeredDate      DateTime?
  isRegistered        Boolean    @default(false)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  @@map("certified_copy")
}

/// *
/// * Defines the types of civil registry forms
/// * @enum {string}
enum FormType {
  MARRIAGE
  BIRTH
  DEATH
}

/// *
/// * Session Model
/// * @model
/// * Manages active user sessions
/// * Features:
/// * - Secure token management
/// * - Device tracking
/// * - Automatic cleanup
model Session {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String   @db.Uuid
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

/// *
/// * Account Model
/// * @model
/// * Handles external authentication providers
/// * Features:
/// * - OAuth token management
/// * - Multiple provider support
/// * - Automatic token refresh
model Account {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  accountId             String
  providerId            String
  userId                String    @db.Uuid
  password              String?
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

/// *
/// * Verification Model
/// * @model
/// * Handles time-sensitive verification tokens
/// * Used for:
/// * - Email verification
/// * - Password reset
/// * - Account confirmation
model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}

/// *
/// * Queue Model
/// * @model
/// * Manages document service requests
/// * Features:
/// * - Automatic ticket numbering
/// * - Status tracking
/// * - Processing notes
model Queue {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ticketNumber    Int         @unique @default(autoincrement())
  kioskNumber     Int?
  status          QueueStatus @default(WAITING)
  serviceType     ServiceType
  userId          String?     @db.Uuid
  email           String?
  documents       String[]
  processingNotes String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  completedAt     DateTime?
  user            User?       @relation(fields: [userId], references: [id])

  @@map("queue")
}

/// *
/// * Profile Model
/// * @model
/// * Extended user information
/// * Stores:
/// * - Personal details
/// * - Contact information
/// * - Demographic data
model Profile {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @unique @db.Uuid
  dateOfBirth DateTime?
  phoneNumber String?
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  bio         String?
  occupation  String?
  gender      String?
  nationality String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profile")
}

/// *
/// * Document Model
/// * @model
/// * Central document repository
/// * Features:
/// * - Version control
/// * - Metadata storage
/// * - Workflow integration
model Document {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type          AttachmentType
  title         String
  description   String?
  metadata      Json?
  status        DocumentStatus @default(PENDING)
  version       Int            @default(1)
  isLatest      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  attachments   Attachment[]
  auditLogs     AuditLog[]
  workflowSteps WorkflowStep[]

  @@map("document")
}

/// *
/// * Attachment Model
/// * @model
/// * Handles physical document files
/// * Features:
/// * - File metadata
/// * - Document verification
/// * - Processing status
model Attachment {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String          @db.Uuid
  documentId      String          @db.Uuid
  type            AttachmentType
  fileUrl         String
  fileName        String
  fileSize        Int
  mimeType        String
  status          DocumentStatus  @default(PENDING)
  uploadedAt      DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  verifiedAt      DateTime?
  notes           String?
  metadata        Json?
  hash            String?
  document        Document        @relation(fields: [documentId], references: [id])
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  certifiedCopies CertifiedCopy[]

  @@map("attachment")
}

/// *
/// * Workflow Model
/// * @model
/// * Defines document processing workflows
/// * Features:
/// * - Customizable steps
/// * - Active status tracking
/// * - Creator attribution
model Workflow {
  id          String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  createdBy   String         @db.Uuid
  user        User           @relation(fields: [createdBy], references: [id])
  steps       WorkflowStep[]

  @@map("workflow")
}

/// *
/// * WorkflowStep Model
/// * @model
/// * Individual workflow process steps
/// * Features:
/// * - Order management
/// * - Deadline tracking
/// * - Requirement flags
model WorkflowStep {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workflowId String    @db.Uuid
  documentId String    @db.Uuid
  name       String
  order      Int
  isRequired Boolean   @default(true)
  deadline   DateTime?
  status     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  document   Document  @relation(fields: [documentId], references: [id])
  workflow   Workflow  @relation(fields: [workflowId], references: [id])

  @@map("workflow_step")
}

/// *
/// * Notification Model
/// * @model
/// * System notification management
/// * Features:
/// * - Multiple notification types
/// * - Read status tracking
/// * - Timestamp logging
model Notification {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String           @db.Uuid
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  readAt    DateTime?
  user      User             @relation(fields: [userId], references: [id])

  @@map("notification")
}

/// *
/// * AuditLog Model
/// * @model
/// * System activity tracking
/// * Features:
/// * - Detailed action logging
/// * - Entity tracking
/// * - User attribution
model AuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @db.Uuid
  action     String
  entityType String
  entityId   String   @db.Uuid
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [entityId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@map("audit_log")
}

/// *
/// * Feedback Model
/// * @model
/// * Allows for user-submitted feedback
model Feedback {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  feedback    String
  submittedBy String?  @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User? @relation(fields: [submittedBy], references: [id])

  @@map("feedback")
}

/// *
/// * Defines user role levels in the system
/// * @enum {string}
/// * - ADMIN: Full system access and management capabilities
/// * - STAFF: Limited administrative access for daily operations
/// * - USER: Basic access for standard users
enum UserRole {
  ADMIN
  STAFF
  USER
}

/// *
/// * Defines the possible states of a queue item
/// * @enum {string}
/// * - WAITING: Initial state when request is created
/// * - PROCESSING: Request is being handled by staff
/// * - COMPLETED: Request has been successfully processed
/// * - CANCELLED: Request was terminated before completion
enum QueueStatus {
  WAITING
  PROCESSING
  COMPLETED
  CANCELLED
}

/// *
/// * Defines the types of services available
/// * @enum {string}
/// * - TRUE_COPY: Request for certified true copies
/// * - VERIFY: Document verification service
/// * - CERTIFICATION: New certificate issuance
/// * - AUTHENTICATION: Document authentication service
enum ServiceType {
  TRUE_COPY
  VERIFY
  CERTIFICATION
  AUTHENTICATION
}

/// *
/// * Defines granular system permissions
/// * @enum {string}
/// * Each permission controls access to specific system functionality
enum Permission {
  QUEUE_VIEW
  QUEUE_PROCESS
  QUEUE_DELETE
  QUEUE_UPDATE
  QUEUE_ADD_NOTES
  USERS_MANAGE
  DOCUMENTS_MANAGE
  WORKFLOW_MANAGE
  REPORTS_VIEW
  SYSTEM_SETTINGS
}

/// *
/// * Defines document processing states
/// * @enum {string}
/// * Tracks the verification status of documents
enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

/// *
/// * Defines notification delivery channels
/// * @enum {string}
/// * Supports multiple communication methods
enum NotificationType {
  EMAIL
  SYSTEM
  SMS
}

/// *
/// * Defines types of civil registry documents
/// * @enum {string}
/// * Categories for different certificate types
enum AttachmentType {
  BIRTH_CERTIFICATE
  DEATH_CERTIFICATE
  MARRIAGE_CERTIFICATE
}
